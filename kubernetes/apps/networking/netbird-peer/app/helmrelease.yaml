# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: netbird-peer
spec:
  interval: 30m
  chartRef:
    kind: OCIRepository
    name: app-template
  values:
    controllers:
      netbird-peer:
        replicas: 3
        annotations:
          reloader.stakater.com/auto: "true"
        pod:
          topologySpreadConstraints:
            - maxSkew: 1
              topologyKey: kubernetes.io/hostname
              whenUnsatisfiable: DoNotSchedule
              labelSelector:
                matchLabels:
                  app.kubernetes.io/name: netbird-peer
        containers:
          app:
            image:
              repository: netbirdio/netbird
              tag: 0.61.2@sha256:6c22aac6b14505a76eac551103f8016f510e634a0c42b6872eaec40853cbb4ae
            env:
              MANAGEMENT_URL: https://netbird.${SECRET_DOMAIN}:443
              NB_HOSTNAME:
                valueFrom:
                  fieldRef:
                    fieldPath: metadata.name
              NB_LOG_LEVEL: info
            envFrom:
              - secretRef:
                  name: netbird-peer-secrets
            securityContext:
              allowPrivilegeEscalation: false
              readOnlyRootFilesystem: true
              capabilities:
                drop:
                  - ALL
                add:
                  - NET_ADMIN
                  - SYS_ADMIN
                  - SYS_RESOURCE
            resources:
              requests:
                cpu: 25m
                memory: 105Mi
              limits:
                memory: 500Mi
    persistence:
      tmpfs:
        type: emptyDir
        advancedMounts:
          netbird-peer:
            app:
              - path: /var/log
                subPath: log
              - path: /var/run
                subPath: run
              - path: /var/lib/netbird
                subPath: lib/netbird
