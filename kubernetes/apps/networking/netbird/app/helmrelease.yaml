---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app netbird
spec:
  interval: 10m
  chart:
    spec:
      chart: *app
      version: 1.9.0
      sourceRef:
        kind: HelmRepository
        name: *app
        namespace: flux-system
  maxHistory: 3
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    fullnameOverride: *app

    management:
      configmap: |-
        {
          "Stuns": [
            {
              "Proto": "udp",
              "URI": "{{ .STUN_SERVER }}",
              "Username": "",
              "Password": ""
            }
          ],
          "TURNConfig": {
            "TimeBasedCredentials": false,
            "CredentialsTTL": "12h0m0s",
            "Secret": "secret",
            "Turns": [
              {
                "Proto": "udp",
                "URI": "{{ .TURN_SERVER }}",
                "Username": "{{ .TURN_SERVER_USER }}",
                "Password": "{{ .TURN_SERVER_PASSWORD }}"
              }
            ]
          },
          "Relay": {
            "Addresses": ["rel://netbird.${SECRET_DOMAIN}:443/relay"],
            "CredentialsTTL": "24h",
            "Secret": "{{ .RELAY_PASSWORD }}"
          },
          "Signal": {
            "Proto": "https",
            "URI": "netbird.${SECRET_DOMAIN}:443",
            "Username": "",
            "Password": ""
          },
          "Datadir": "/var/lib/netbird/",
          "DataStoreEncryptionKey": "{{ .DATASTORE_ENCRYPTION_KEY }}",
          "HttpConfig": {
            "LetsEncryptDomain": "",
            "CertFile": "",
            "CertKey": "",
            "AuthAudience": "{{ .IDP_AUDIENCE }}",
            "AuthIssuer": "https://auth.${SECRET_DOMAIN}",
            "AuthUserIDClaim": "",
            "AuthKeysLocation": "https://auth.${SECRET_DOMAIN}/jwks.json",
            "OIDCConfigEndpoint": "https://auth.${SECRET_DOMAIN}/.well-known/openid-configuration",
            "IdpSignKeyRefreshEnabled": false
          },
          "IdpManagerConfig": {
            "ManagerType": "none",
            "ClientConfig": {
              "Issuer": "https://auth.${SECRET_DOMAIN}",
              "TokenEndpoint": "https://auth.${SECRET_DOMAIN}/api/oidc/token",
              "ClientID": "{{ .IDP_CLIENT_ID }}",
              "ClientSecret": "",
              "GrantType": "client_credentials"
            },
            "ExtraConfig": {
              "Password": "{{ .IDP_SERVICE_ACCOUNT_PASSWORD }}",
              "Username": "{{ .IDP_SERVICE_ACCOUNT_USER }}"
            },
            "Auth0ClientCredentials": null,
            "AzureClientCredentials": null,
            "KeycloakClientCredentials": null,
            "ZitadelClientCredentials": null
          },
          "DeviceAuthorizationFlow": {
            "Provider": "none",
            "ProviderConfig": {
              "ClientID": "",
              "ClientSecret": "",
              "Domain": "",
              "Audience": "{{ .IDP_AUDIENCE }}",
              "TokenEndpoint": "https://auth.${SECRET_DOMAIN}/api/oidc/token/",
              "DeviceAuthEndpoint": "https://auth.${SECRET_DOMAIN}/api/oidc/device-authorization",
              "AuthorizationEndpoint": "",
              "Scope": "openid",
              "UseIDToken": false,
              "RedirectURLs": null
            }
          },
          "PKCEAuthorizationFlow": {
            "ProviderConfig": {
              "ClientID": "{{ .IDP_CLIENT_ID }}",
              "ClientSecret": "{{ .IDP_CLIENT_SECRET }}",
              "Domain": "",
              "Audience": "{{ .IDP_AUDIENCE }}",
              "TokenEndpoint": "https://auth.${SECRET_DOMAIN}/api/oidc/token/",
              "DeviceAuthEndpoint": "",
              "AuthorizationEndpoint": "https://auth.${SECRET_DOMAIN}/api/oidc/authorization",
              "Scope": "openid profile email",
              "UseIDToken": true,
              "DisablePromptLogin": true,
              "RedirectURLs": ["http://localhost:53000"]
            }
          },
          "StoreConfig": {
            "Engine": "postgres"
          },
          "ReverseProxy": {
            "TrustedHTTPProxies": null,
            "TrustedHTTPProxiesCount": 0,
            "TrustedPeers": null
          }
        }

      ingress:
        enabled: true
        className: external
        annotations:
          external-dns.home.arpa/enabled: "true"
        hosts:
          - host: &host netbird.${SECRET_DOMAIN}
            paths:
              - path: /api
                pathType: ImplementationSpecific

      ingressGrpc:
        enabled: true
        className: external
        annotations:
          external-dns.home.arpa/enabled: "true"
          nginx.ingress.kubernetes.io/backend-protocol: GRPC
          nginx.ingress.kubernetes.io/ssl-redirect: "true"
          nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
          nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
        hosts:
          - host: *host
            paths:
              - path: /management.ManagementService
                pathType: ImplementationSpecific

      persistentVolume:
        enabled: true
        accessModes:
          - ReadWriteMany
        storageClass: netbird-apps
        existingPVName: netbird-apps
        size: 1Mi

      env:
        NETBIRD_DISABLE_GEOLITE_UPDATE: "true"

      envFromSecret:
        NETBIRD_STORE_ENGINE_POSTGRES_DSN: netbird-secret/postgresDSN
        STUN_SERVER: netbird-secret/stunServer
        TURN_SERVER: netbird-secret/turnServer
        TURN_SERVER_USER: netbird-secret/turnServerUser
        TURN_SERVER_PASSWORD: netbird-secret/turnServerPassword
        RELAY_PASSWORD: netbird-secret/relayPassword
        DATASTORE_ENCRYPTION_KEY: netbird-secret/datastoreEncryptionKey
        IDP_CLIENT_ID: netbird-secret/idpClientID
        IDP_AUDIENCE: netbird-secret/idpAudience
        IDP_SERVICE_ACCOUNT_USER: netbird-secret/idpServiceAccountUser
        IDP_SERVICE_ACCOUNT_PASSWORD: netbird-secret/idpServiceAccountPassword

      useBackwardsGrpcService: true

    signal:
      ingress:
        enabled: true
        className: external
        annotations:
          external-dns.home.arpa/enabled: "true"
          nginx.ingress.kubernetes.io/backend-protocol: GRPC
          nginx.ingress.kubernetes.io/ssl-redirect: "true"
          nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
          nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
        hosts:
          - host: *host
            paths:
              - path: /signalexchange.SignalExchange
                pathType: ImplementationSpecific

    relay:
      containerPort: 443

      service:
        port: 443

      ingress:
        enabled: true
        className: external
        annotations:
          external-dns.home.arpa/enabled: "true"
        hosts:
          - host: *host
            paths:
              - path: /relay
                pathType: ImplementationSpecific

      envFromSecret:
        NB_AUTH_SECRET: netbird-secret/relayPassword

      env:
        NB_LOG_LEVEL: info
        NB_LISTEN_PORT: ":443"
        NB_EXPOSED_ADDRESS: netbird.${SECRET_DOMAIN}:443/relay

    dashboard:
      ingress:
        enabled: true
        className: external
        annotations:
          external-dns.home.arpa/enabled: "true"
        hosts:
          - host: *host
            paths:
              - path: /
                pathType: ImplementationSpecific

      env:
        # Endpoints
        NETBIRD_MGMT_API_ENDPOINT: &management https://netbird.${SECRET_DOMAIN}:443
        NETBIRD_MGMT_GRPC_API_ENDPOINT: *management
        # OIDC
        USE_AUTH0: false
        AUTH_REDIRECT_URI: '/peers'
        AUTH_SILENT_REDIRECT_URI: '/add-peers'
        AUTH_AUTHORITY: https://auth.${SECRET_DOMAIN}
        AUTH_SUPPORTED_SCOPES: openid profile email
        NETBIRD_TOKEN_SOURCE: idToken
        # SSL
        NGINX_SSL_PORT:
        LETSENCRYPT_DOMAIN:
        LETSENCRYPT_EMAIL:

      envFromSecret:
        AUTH_CLIENT_ID: netbird-secret/idpClientID
        AUTH_AUDIENCE: netbird-secret/idpAudience
        AUTH_CLIENT_SECRET: netbird-secret/idpClientSecret
