---
theme: dark

log:
  level: info

server:
  disable_healthcheck: true
  buffers:
    read: 2048000

telemetry:
  metrics:
    enabled: true

authentication_backend:
  ldap:
    implementation: lldap
    address: ldap://lldap.identity.svc.cluster.local:389
    base_dn: ${SECRET_LDAP_ROOT}
    user: ${LLDAP_USER_DN}
    password: ${LLDAP_LDAP_USER_PASS}
    users_filter: (&(|({username_attribute}={input})({mail_attribute}={input}))(objectClass=person))

notifier:
  disable_startup_check: true
  smtp:
    host: smtp-relay.networking.svc.cluster.local
    port: ${SMTP_RELAY_PORT}
    sender: Authelia <noreply@${SECRET_DOMAIN}>
    disable_require_tls: true

session:
  same_site: lax
  inactivity: 5m
  expiration: 1h
  remember_me: 1M
  cookies:
    - name: authelia_session
      domain: ${SECRET_DOMAIN}
      authelia_url: https://auth.${SECRET_DOMAIN}
      default_redirection_url: https://hajimari.${SECRET_DOMAIN}
  redis:
    host: dragonfly.storage.svc.cluster.local
    database_index: 2

duo_api:
  disable: true

access_control:
  default_policy: two_factor
  networks:
    - name: internal
      networks:
        - 10.0.0.0/8
        - 172.16.0.0/12
        - 192.168.0.0/16
  rules:
    - domain:
        - "*.${SECRET_DOMAIN}"
      policy: bypass
      query:
        - - operator: "pattern"
            key: "apikey"
            value: "${GATUS_AUTHELIA_APIKEY}"

    - domain: kromgo.${SECRET_DOMAIN}
      policy: bypass
      query:
        - - operator: "pattern"
            key: "apikey"
            value: "${KROMGO_AUTHELIA_APIKEY}"

    - domain: auth.${SECRET_DOMAIN}
      policy: bypass
    - domain:
        - "actual.${SECRET_DOMAIN}"
        - "paperless.${SECRET_DOMAIN}"
        - "mealie.${SECRET_DOMAIN}"
        - "memos.${SECRET_DOMAIN}"
        - "notes.${SECRET_DOMAIN}"
        - "nextcloud.${SECRET_DOMAIN}"
        - "netbird.${SECRET_DOMAIN}"
      policy: one_factor
      subject:
        - ["group:admin", "group:family", "group:developer"]

    - domain:
        - "*.${SECRET_DOMAIN}"
      policy: two_factor
      subject:
        - ["group:admin"]

definitions:
  user_attributes:
    is_nextcloud_admin:
      expression: '"admin" in groups'

identity_providers:
  oidc:
    jwks:
      - key: |-
          ${AUTHELIA_IDENTITY_PROVIDERS_OIDC_ISSUER_PRIVATE_KEY}
    cors:
      endpoints:
        - authorization
        - token
        - revocation
        - introspection
      allowed_origins_from_client_redirect_uris: true
    claims_policies:
      nextcloud_userinfo:
        custom_claims:
          is_nextcloud_admin: {}
    scopes:
      nextcloud_userinfo:
        claims:
          - is_nextcloud_admin
    clients:
      - client_id: grafana
        client_name: Grafana
        client_secret: ${GRAFANA_OAUTH_CLIENT_SECRET}
        public: false
        authorization_policy: two_factor
        pre_configured_consent_duration: 1y
        require_pkce: false
        scopes:
          - openid
          - profile
          - groups
          - email
        redirect_uris:
          - https://grafana.${SECRET_DOMAIN}/login/generic_oauth
        response_types:
          - code
        grant_types:
          - authorization_code
          - refresh_token
        access_token_signed_response_alg: none
        userinfo_signed_response_alg: none
        token_endpoint_auth_method: client_secret_basic

      - client_id: paperless
        client_name: Paperless
        client_secret: ${PAPERLESS_OAUTH_CLIENT_SECRET}
        public: false
        authorization_policy: two_factor
        pre_configured_consent_duration: 1y
        require_pkce: false
        scopes:
          - openid
          - profile
          - groups
          - email
        redirect_uris:
          - https://paperless.${SECRET_DOMAIN}/accounts/oidc/authelia/login/callback/
        response_types:
          - code
        grant_types:
          - authorization_code
          - refresh_token
        access_token_signed_response_alg: none
        userinfo_signed_response_alg: none
        token_endpoint_auth_method: client_secret_basic

      - client_id: pgadmin
        client_name: PG Admin
        client_secret: ${PG_OAUTH2_CLIENT_SECRET}
        public: false
        authorization_policy: two_factor
        pre_configured_consent_duration: 1y
        require_pkce: false
        scopes:
          - openid
          - profile
          - groups
          - email
        redirect_uris:
          - https://pgadmin.${SECRET_DOMAIN}/oauth2/authorize
        response_types:
          - code
        grant_types:
          - authorization_code
          - refresh_token
        access_token_signed_response_alg: none
        userinfo_signed_response_alg: none
        token_endpoint_auth_method: client_secret_basic

      - client_id: teleport
        client_name: Teleport
        client_secret: ${TELEPORT_OIDC_CLIENT_SECRET}
        public: false
        authorization_policy: two_factor
        pre_configured_consent_duration: 1y
        require_pkce: false
        scopes:
          - openid
          - profile
          - groups
          - email
        redirect_uris:
          - https://teleport.${SECRET_DOMAIN}/v1/webapi/oidc/callback
        response_types:
          - code
        grant_types:
          - authorization_code
          - refresh_token
        access_token_signed_response_alg: none
        userinfo_signed_response_alg: none
        token_endpoint_auth_method: client_secret_basic

      - client_id: actual
        client_name: Actual
        client_secret: ${ACTUAL_OPENID_CLIENT_SECRET}
        public: false
        authorization_policy: one_factor
        pre_configured_consent_duration: 1y
        require_pkce: false
        scopes:
          - openid
          - profile
          - groups
          - email
        redirect_uris:
          - https://actual.${SECRET_DOMAIN}/openid/callback
        response_types:
          - code
        grant_types:
          - authorization_code
        access_token_signed_response_alg: none
        userinfo_signed_response_alg: none
        token_endpoint_auth_method: client_secret_basic

      - client_id: mealie
        client_name: Mealie
        client_secret: ${MEALIE_OIDC_CLIENT_SECRET}
        public: false
        authorization_policy: one_factor
        pre_configured_consent_duration: 1y
        require_pkce: true
        pkce_challenge_method: S256
        scopes:
          - openid
          - profile
          - groups
          - email
        redirect_uris:
          - https://mealie.${SECRET_DOMAIN}/login
        response_types:
          - code
        grant_types:
          - authorization_code
        access_token_signed_response_alg: none
        userinfo_signed_response_alg: none
        token_endpoint_auth_method: client_secret_basic

      - client_id: memos
        client_name: Memos
        client_secret: ${MEMOS_OIDC_CLIENT_SECRET}
        public: false
        authorization_policy: one_factor
        pre_configured_consent_duration: 1y
        require_pkce: false
        scopes:
          - openid
          - profile
          - groups
          - email
        redirect_uris:
          - https://notes.${SECRET_DOMAIN}/auth/callback
          - https://memos.${SECRET_DOMAIN}/auth/callback
        response_types:
          - code
        grant_types:
          - authorization_code
          - refresh_token
        access_token_signed_response_alg: none
        userinfo_signed_response_alg: none
        token_endpoint_auth_method: client_secret_post

      - client_id: ledgerlink
        client_name: Ledger Link
        client_secret: ${LEDGERLINK_OIDC_CLIENT_SECRET}
        public: false
        authorization_policy: one_factor
        pre_configured_consent_duration: 1y
        require_pkce: true
        pkce_challenge_method: S256
        scopes:
          - openid
          - profile
          - groups
          - email
        redirect_uris:
          - http://localhost:3000/auth/callback
          - https://laughing-lamp-6pqrw4p447h5vqr-3000.app.github.dev/auth/callback
        response_types:
          - code
        grant_types:
          - authorization_code
        access_token_signed_response_alg: none
        userinfo_signed_response_alg: none
        token_endpoint_auth_method: client_secret_basic

      - client_id: nextcloud
        client_name: Nextcloud
        client_secret: ${NEXTCLOUD_OIDC_CLIENT_SECRET}
        public: false
        authorization_policy: one_factor
        pre_configured_consent_duration: 1y
        require_pkce: true
        pkce_challenge_method: S256
        scopes:
          - openid
          - profile
          - email
          - groups
          - nextcloud_userinfo
        redirect_uris:
          - https://nextcloud.${SECRET_DOMAIN}/apps/oidc_login/oidc
        response_types:
          - code
        grant_types:
          - authorization_code
        access_token_signed_response_alg: none
        userinfo_signed_response_alg: none
        token_endpoint_auth_method: client_secret_basic

      - client_id: netbird
        client_name: Netbird
        client_secret: ${NETBIRD_OIDC_CLIENT_SECRET}
        public: false
        authorization_policy: one_factor
        pre_configured_consent_duration: 1y
        require_pkce: false
        scopes:
          - openid
          - profile
          - email
          - groups
        redirect_uris:
          - https://netbird.${SECRET_DOMAIN}/peers
          - https://netbird.${SECRET_DOMAIN}/add-peers
        response_types:
          - code
        grant_types:
          - authorization_code
        audience:
          - netbird
        access_token_signed_response_alg: none
        userinfo_signed_response_alg: none
        token_endpoint_auth_method: client_secret_post
