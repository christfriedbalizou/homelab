---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: &app letibeafrica
spec:
  chartRef:
    kind: OCIRepository
    name: app-template
  interval: 15m
  maxHistory: 2
  install:
    createNamespace: true
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    controllers:
      wordpress:
        annotations:
          reloader.stakater.com/auto: "true"
        pod:
          securityContext:
            runAsNonRoot: true
            runAsUser: 1001
            runAsGroup: 1001
            fsGroup: 1001
            fsGroupChangePolicy: OnRootMismatch
            seccompProfile:
              type: RuntimeDefault
          dnsPolicy: ClusterFirst
          hostAliases:
            - hostnames:
                - status.localhost
              ip: 127.0.0.1
        initContainers:
          01-prepare-base-dir:
            image:
              repository: bitnami/wordpress
              tag: latest
              pullPolicy: IfNotPresent
            command:
              - /bin/bash
            args:
              - '-ec'
              - |
                #!/bin/bash

                . /opt/bitnami/scripts/liblog.sh
                . /opt/bitnami/scripts/libfs.sh

                cp -r --preserve=mode /opt/bitnami/wordpress /emptydir/app-base-dir

                if ! is_dir_empty /opt/bitnami/apache/logs; then
                  cp -r /opt/bitnami/apache/logs /emptydir/apache-logs-dir
                fi

                cp -r --preserve=mode /opt/bitnami/php/etc /emptydir/php-conf-dir

                if ! is_dir_empty /opt/bitnami/php/var; then
                  cp -r /opt/bitnami/php/var /emptydir/php-var-dir
                fi
            env:
              OPENSSL_FIPS: "yes"
            resources: &resources
              limits:
                memory: 1025Mi
              requests:
                cpu: 250m
                memory: 256Mi
        containers:
          app:
            image:
              repository: bitnamisecure/wordpress
              tag: latest@sha256:ddc304a32326b5f8156cd2f050c41973f5e0d90d6dbebeda0e0859351cb4c071
            env:
              MARIADB_HOST: mariadb.storage.svc.cluster.local
              MARIADB_PORT_NUMBER: "3306"
              WORDPRESS_DATABASE_NAME: *app
              WORDPRESS_DATABASE_USER: *app
              WORDPRESS_DATABASE_PASSWORD_FILE: /secrets/mariadb-password

              WORDPRESS_USERNAME: *app
              WORDPRESS_PASSWORD_FILE: /secrets/wordpress-password

              WORDPRESS_ALLOW_EMPTY_PASSWORD: "yes"
              WORDPRESS_SKIP_BOOTSTRAP: "no"
              WORDPRESS_TABLE_PREFIX: wp_
              WORDPRESS_SCHEME: http

              APACHE_HTTP_PORT_NUMBER: "8080"
              APACHE_HTTPS_PORT_NUMBER: "8443"

              BITNAMI_DEBUG: "false"

            resources: *resources
            probes:
              liveness: &probes
                enabled: true
                custom: true
                spec:
                  httpGet:
                    path: /wp-login.php
                    port: &port 8080
                  initialDelaySeconds: 0
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3
              readiness: *probes
    service:
      app:
        controller: wordpress
        ports:
          http:
            port: *port

    ingress:
      app:
        className: external
        annotations:
          external-dns.home.arpa/enabled: "true"
        hosts:
          - host: letibeafrica.${SECRET_DOMAIN}
            paths:
              - path: /
                pathType: Prefix
                service:
                  identifier: app
                  port: http

    persistence:
      config:
        type: nfs
        server: ${NFS_SERVER}
        path: /volume1/apps/default
        globalMounts:
          - subPath: letibeafrica
            path: /bitnami/wordpress

      emptydir:
        type: emptyDir
        advancedMounts:
          wordpress:
            app:
              - path: /opt/bitnami/apache/conf
                subPath: apache-conf-dir
              - path: /opt/bitnami/apache/logs
                subPath: apache-logs-dir
              - path: /opt/bitnami/apache/var/run
                subPath: apache-tmp-dir
              - path: /opt/bitnami/php/etc
                subPath: php-conf-dir
              - path: /opt/bitnami/php/tmp
                subPath: php-tmp-dir
              - path: /opt/bitnami/php/var
                subPath: php-var-dir
              - path: /tmp
                subPath: tmp-dir
              - path: /opt/bitnami/wordpress
                subPath: app-base-dir
            01-prepare-base-dir:
              - path: /emptydir

      secrets:
        type: secret
        name: letibeafrica-secret
        globalMounts:
          - subPath: wordpress-password
            path: /secrets/wordpress-password
            readOnly: true
          - subPath: mariadb-password
            path: /secrets/mariadb-password
            readOnly: true
