---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: teleport-cluster
  namespace: storage
spec:
  interval: 30m
  chart:
    spec:
      chart: teleport-cluster
      version: 18.1.0
      sourceRef:
        kind: HelmRepository
        name: teleport
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    global:
      installCRDs: never

    auth:
      teleport:
        storage:
          type: postgresql
          conn_string: "postgres://teleport:${TELEPORT_DBPASS}@postgres-lb.storage.svc.cluster.local/teleport-core?sslmode=disable"
          audit_events_uri: "postgres://teleport:${TELEPORT_DBPASS}@postgres-lb.storage.svc.cluster.local/teleport-audit?sslmode=disable"
        auth_service:
          client_idle_timeout: 30m
          session_recording: "off"

    authentication:
      type: oidc
      connectorName: teleport-oidc
      localAuth: false
      lockingMode: strict

    proxy:
      annotations:
        ingress:
          external-dns.home.arpa/enabled: "true"
          auth.home.arpa/enabled: "true"
          hajimari.io/enable: "true"
          hajimari.io/icon: "eos-icons:cluster-management-outlined"
          hajimari.io/group: "System"
        deployment:
          reloader.stakater.com/auto: "true"
      teleportConfig:
        proxy_service:
          trust_x_forwarded_for: true

    operator:
      enable: true

    enterprise: false

    publicAddr:
      - teleport.${SECRET_DOMAIN}

    podMonitor:
      additionalLabels:
        prometheus: default
      enabled: true
      interval: 30s

    podSecurityPolicy:
      enabled: true

    initContainers:
      - name: "01-init-db"
        image: ghcr.io/home-operations/postgres-init:17
        imagePullPolicy: IfNotPresent
        env:
          - name: "INIT_POSTGRES_DBNAME"
            value: "teleport-core teleport-audit"
          - name: "INIT_POSTGRES_HOST"
            value: postgres-lb.storage.svc.cluster.local
          - name: "INIT_POSTGRES_USER"
            value: "teleport"
          - name: "INIT_POSTGRES_PASS"
            value: "${TELEPORT_DBPASS}"
          - name: "INIT_POSTGRES_SUPER_PASS"
            value: "${POSTGRES_SUPER_PASS}"

